{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///D:/KULIAH%20SMT%207/Chatbot-Gen-AI-main/app/api/generate-image/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport Groq from 'groq-sdk';\r\nimport { exec } from 'child_process';\r\nimport { promisify } from 'util';\r\nimport path from 'path';\r\n\r\nconst execAsync = promisify(exec);\r\n\r\nconst groq = new Groq({\r\n    apiKey: process.env.GROQ_API_KEY || ''\r\n});\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const { prompt } = await req.json();\r\n\r\n        if (!prompt || typeof prompt !== 'string') {\r\n            return NextResponse.json(\r\n                { error: 'Prompt is required and must be a string' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        console.log('Generating image for prompt:', prompt);\r\n\r\n        // Step 1: Gunakan Llama untuk translate & enhance prompt (Indonesia → English)\r\n        let enhancedPrompt = prompt;\r\n        \r\n        if (process.env.GROQ_API_KEY) {\r\n            try {\r\n                const completion = await groq.chat.completions.create({\r\n                    messages: [\r\n                        {\r\n                            role: \"system\",\r\n                            content: \"You are an expert at creating image generation prompts. Translate Indonesian to English and create a detailed, high-quality prompt for Stable Diffusion. Include style descriptors like 'highly detailed, 8k uhd, studio lighting, professional, vivid colors'. Keep under 77 tokens. Return ONLY the prompt.\"\r\n                        },\r\n                        {\r\n                            role: \"user\",\r\n                            content: prompt\r\n                        }\r\n                    ],\r\n                    model: \"llama-3.3-70b-versatile\",\r\n                    temperature: 0.7,\r\n                    max_tokens: 100,\r\n                });\r\n\r\n                enhancedPrompt = completion.choices[0]?.message?.content?.trim() || prompt;\r\n                console.log('Enhanced prompt:', enhancedPrompt);\r\n            } catch (error) {\r\n                console.log('Llama enhancement failed, using original prompt');\r\n            }\r\n        }\r\n\r\n        // Step 2: Generate dengan Python Stable Diffusion (local GPU)\r\n        const cleanPrompt = enhancedPrompt.substring(0, 200).trim();\r\n        console.log(`Generating with local Stable Diffusion: ${cleanPrompt}`);\r\n\r\n        try {\r\n            const pythonScript = path.join(process.cwd(), 'python-backend', 'generate_image.py');\r\n            const pythonCommand = `python \"${pythonScript}\" \"${cleanPrompt.replace(/\"/g, '\\\\\"')}\"`;\r\n            \r\n            console.log('Executing Python script...');\r\n            const { stdout, stderr } = await execAsync(pythonCommand, {\r\n                timeout: 120000, // 2 minutes timeout\r\n                maxBuffer: 10 * 1024 * 1024 // 10MB buffer for base64 image\r\n            });\r\n\r\n            if (stderr) {\r\n                console.log('Python stderr:', stderr);\r\n            }\r\n\r\n            const result = JSON.parse(stdout);\r\n\r\n            if (!result.success) {\r\n                throw new Error(result.error || 'Python script failed');\r\n            }\r\n\r\n            const imageUrl = `data:image/png;base64,${result.imageBase64}`;\r\n\r\n            console.log('✓ Image generated successfully with local Stable Diffusion');\r\n\r\n            return NextResponse.json({ \r\n                imageUrl,\r\n                prompt: prompt,\r\n                enhancedPrompt: enhancedPrompt,\r\n                method: 'local-stable-diffusion'\r\n            });\r\n\r\n        } catch (pythonError: any) {\r\n            console.error('Local Stable Diffusion failed:', pythonError.message);\r\n            \r\n            // Fallback to Hugging Face API if Python fails\r\n            console.log('Falling back to Hugging Face API...');\r\n            \r\n            if (!process.env.HUGGINGFACE_API_KEY) {\r\n                throw new Error('Python failed dan Hugging Face API key tidak tersedia. Install: pip install -U diffusers transformers accelerate torch');\r\n            }\r\n\r\n            // Try multiple working free models as fallback\r\n            const models = [\r\n                'stabilityai/stable-diffusion-xl-base-1.0',\r\n                'prompthero/openjourney-v4',\r\n                'runwayml/stable-diffusion-v1-5'\r\n            ];\r\n\r\n            let imageBuffer = null;\r\n            let usedModel = '';\r\n\r\n            for (const model of models) {\r\n            try {\r\n                console.log(`Trying model: ${model}`);\r\n                \r\n                const response = await fetch(\r\n                    `https://api-inference.huggingface.co/models/${model}`,\r\n                    {\r\n                        method: 'POST',\r\n                        headers: {\r\n                            'Authorization': `Bearer ${process.env.HUGGINGFACE_API_KEY}`,\r\n                        },\r\n                        body: JSON.stringify({ \r\n                            inputs: cleanPrompt,\r\n                            options: { wait_for_model: true }\r\n                        }),\r\n                    }\r\n                );\r\n\r\n                if (response.ok) {\r\n                    imageBuffer = await response.arrayBuffer();\r\n                    usedModel = model;\r\n                    console.log(`✓ Success with: ${model}`);\r\n                    break;\r\n                }\r\n\r\n                const errorText = await response.text();\r\n                console.log(`✗ ${model} failed (${response.status}):`, errorText);\r\n                \r\n            } catch (error: any) {\r\n                    console.log(`✗ HF ${model} error:`, error.message);\r\n                }\r\n            }\r\n\r\n            if (!imageBuffer) {\r\n                throw new Error('Local Python dan Hugging Face API semua gagal.');\r\n            }\r\n\r\n            // Convert to base64\r\n            const base64Image = Buffer.from(imageBuffer).toString('base64');\r\n            const imageUrl = `data:image/png;base64,${base64Image}`;\r\n\r\n            console.log(`Image generated with HF fallback: ${usedModel}`);\r\n\r\n            return NextResponse.json({ \r\n                imageUrl,\r\n                prompt: prompt,\r\n                enhancedPrompt: enhancedPrompt,\r\n                method: 'huggingface-fallback'\r\n            });\r\n        }\r\n\r\n    } catch (error: any) {\r\n        console.error('Error generating image:', error);\r\n        return NextResponse.json(\r\n            { error: error.message || 'Gagal membuat gambar' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}